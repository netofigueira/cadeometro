
<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Busca </title>
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}
	</style>

	
</head>
<body>


<div class="container text-center"> 
    
    <h3> Encontrar Imóveis</h3>
     <p> clique nas estações para visualizar os imóveis mais próximos </p>
</div> 

    <div id="map" style="width: 80%; height: 80%; margin: auto; border-radius: 10px; display: flex; justify-content: center; align-items: center;"></div>

    <!-- Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
            </ol>
            <!-- Slides -->
            <div class="carousel-inner">
            </div>
            <!-- Controls -->

                <!-- tentei botar o javascript direto aqui mas o carrossel n ta funcionando da maneira correta -->
                <a class="left carousel-control" id='nextBtn' href="#carouselExampleIndicators" data-slide="prev" onclick="$('#carouselExampleIndicators').carousel('prev')">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                    <span class="sr-only">Previous</span>
                </a>

                
                <a class="right carousel-control" id='prevBtn' href="#carouselExampleIndicators" data-slide="next" onclick="$('#carouselExampleIndicators').carousel('next')">
                    <span class="glyphicon glyphicon-chevron-right"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
        </div>
    </div>
  


</body>
<script>


    var stationIcon = L.icon({
        iconUrl: '/static/img/metrosp-logopq.png',

        iconSize:     [30, 30], // size of the icon
        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });

    var lats = {{ lats|safe }};
    var lngs = {{ lngs|safe }};
    var names = {{ names|safe }};
    var markers_added = [];

	const map = L.map('map').setView([lats[0], lngs[0]], 13);

	const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);


    // loop adiciona os pontos de estacao
    for (var i = 0; i < lats.length; i++) {
        marker =  L.marker([lats[i],lngs[i]], {icon: stationIcon}).addTo(map);
        marker.bindPopup(names[i]).openPopup();

        // when click at it, load building markers
        marker.on('click', function() {
            getNewMarkers(this.getLatLng().lat, this.getLatLng().lng);
        });
}

function getNewMarkers(lat, lng) {
    $.ajax({
        type: "GET",
        url: "/get_quinto_andar_data",
        data: { lat: lat, lng: lng },
        success: function(data) {

            	// Remove previously added markers and polylines
            for (var i = 0; i < markers_added.length; i++) {
                map.removeLayer(markers_added[i]);
            }
            markers_added = [];

            let station_lat = lat;
            let station_lng = lng;
            //  instantiate the buildings returned from backend
            let buildings = data.buildings;
            //  load the buildings into map
            for (let i = 0; i < buildings.length; i++) {
                let building = buildings[i];
                marker = L.marker([building.lat, building.lng])
                    .addTo(map).bindPopup("<a 'target=_blank'>" + building.url+ "</a>").openPopup();
                
                getWakingDirections(`${building.lng},${building.lat}`, `${station_lng},${station_lat}`,);

                marker.on('click', function() {
                    getPhoto(building.building_id);

                });


                markers_added.push(marker);
            }
        }
    });
}
       
function getPhoto(building_id) {
    $.ajax({
        type: "GET",
        url: "/get_building_photos",
        data: { building_id:building_id },
        success: function(data) {


            // versao 2 carousel
            let images = data.building_photos;

            console.log(images)

            // Clear carousel
            $("#carouselExampleIndicators").find(".carousel-indicators").empty();
            $("#carouselExampleIndicators").find(".carousel-inner").empty();

            // Fill carousel with images
            for (let i = 0; i < images.length; i++) {

                console.log(i)
                let activeClass = i == 0 ? "active" : "";
                let indicatorHtml = `<li data-target="#carouselExampleIndicators" data-slide-to="${i}" class="${activeClass}"></li>`;
                let imageHtml = `<div class="carousel-item ${activeClass}">
                    <img src="${images[i].photo_url}" class="d-block w-100">
                </div>`;

                $("#carouselExampleIndicators").find(".carousel-indicators").append(indicatorHtml);
                $("#carouselExampleIndicators").find(".carousel-inner").append(imageHtml);
            }

            $('#carouselExampleIndicators').carousel();

            $("#imageModal").modal("show");

            // Get the carousel element
            let carousel = $("#carouselExampleIndicators");

            // Next button click event
            $("#nextBtn").click(function() {
                carousel.carousel("next");
            });

            // Prev button click event
            $("#prevBtn").click(function() {
                carousel.carousel("prev");
        });
        
            
        }



    });
}

function getWakingDirections(start, end){

    console.log(start)
    console.log(end)
    // Define the API endpoint and parameters
    var apiEndpoint = "https://api.openrouteservice.org/v2/directions/foot-walking";
    var apiKey = "5b3ce3597851110001cf624844382de8ef884a54805f919a2573dd35";
    var parameters = {
        start: start,
        end: end,
        api_key: apiKey,
        radius: 1000,
    };

    // Make the API request
    $.ajax({
        url: apiEndpoint,
        type: "GET",
        data: parameters,
        success: function(data) {
            var rawCoordinates = data.features[0].geometry.coordinates;
            var coordinates = rawCoordinates.map(function(coord) {
                return [coord[1], coord[0]];
            });
            var polyline = L.polyline(coordinates, {color: 'red'}).addTo(map);
        }

    });
}
</script>



</body>
</html>
